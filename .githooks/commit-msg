#!/bin/bash

# AlgoShield Commit Message Hook
# Validates commit message format

set -e

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Regex for conventional commits
# Format: type(scope): subject
# Examples:
#   feat: add new rule engine
#   fix(api): correct transaction validation
#   docs: update README
CONVENTIONAL_COMMIT_REGEX='^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: .{1,}'

# Check if commit message follows conventional commits
if ! echo "$COMMIT_MSG" | grep -qE "$CONVENTIONAL_COMMIT_REGEX"; then
    echo -e "${RED}✗ Invalid commit message format${NC}"
    echo ""
    echo -e "${YELLOW}Commit messages should follow the Conventional Commits format:${NC}"
    echo ""
    echo "  <type>(<scope>): <subject>"
    echo ""
    echo -e "${YELLOW}Types:${NC}"
    echo "  feat:     A new feature"
    echo "  fix:      A bug fix"
    echo "  docs:     Documentation only changes"
    echo "  style:    Changes that don't affect code meaning (formatting, etc)"
    echo "  refactor: Code change that neither fixes a bug nor adds a feature"
    echo "  perf:     Performance improvements"
    echo "  test:     Adding or updating tests"
    echo "  chore:    Changes to build process or auxiliary tools"
    echo "  build:    Changes to build system or dependencies"
    echo "  ci:       Changes to CI configuration"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  feat: add transaction velocity check"
    echo "  fix(api): correct rule evaluation logic"
    echo "  docs: update API documentation"
    echo "  test(rules): add unit tests for blocklist rules"
    echo ""
    exit 1
fi

# Check commit message length
SUBJECT_LENGTH=$(echo "$COMMIT_MSG" | head -n1 | wc -c)
if [ "$SUBJECT_LENGTH" -gt 100 ]; then
    echo -e "${YELLOW}⚠ Commit subject is longer than 100 characters${NC}"
    echo -e "${YELLOW}  Consider making it more concise${NC}"
fi

echo -e "${GREEN}✓ Commit message format is valid${NC}"
exit 0

